name: Deploy to Hugging Face
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  debug-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          lfs: true
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install Hugging Face Hub
        run: pip install huggingface_hub

      - name: Debug and Upload
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_REPO_ID: envererman08/stock-analysis-ai
        run: |
          echo "==== DEBUG INFO ===="
          ls -R
          echo "===================="
          
          python -c "
          import os
          import traceback
          from huggingface_hub import HfApi
          
          try:
              print('--> Starting Python Deploy Script')
              
              token = os.environ.get('HF_TOKEN')
              if not token:
                  raise ValueError('HF_TOKEN is missing from environment!')
              print(f'--> Token detected: {token[:4]}***')
              
              repo_id = os.environ.get('HF_REPO_ID')
              print(f'--> Target Repo: {repo_id}')
              
              # Prepare 'stock' folder
              target_dir = 'stock'
              if not os.path.exists(target_dir):
                  raise FileNotFoundError('Stock folder not found!')
                  
              # Rename logic
              src_app = os.path.join(target_dir, 'huggingface_app.py')
              dst_app = os.path.join(target_dir, 'app.py')
              if os.path.exists(src_app):
                  print(f'--> Renaming {src_app} to {dst_app}')
                  os.rename(src_app, dst_app)
                  
              src_req = os.path.join(target_dir, 'requirements_hf.txt')
              dst_req = os.path.join(target_dir, 'requirements.txt')
              if os.path.exists(src_req):
                  print(f'--> Renaming {src_req} to {dst_req}')
                  os.rename(src_req, dst_req)
              
              # Upload
              print('--> Authenticathing...')
              api = HfApi(token=token)
              user = api.whoami()
              print(f'--> Logged in as: {user[\'name\']}')
              
              print('--> Uploading folder...')
              api.upload_folder(
                  folder_path=target_dir,
                  repo_id=repo_id,
                  repo_type='space',
                  ignore_patterns=['__pycache__', '*.git*', 'Dockerfile*']
              )
              print('✅ SUCCESS!')
              
          except Exception as e:
              print('❌ FAILURE DETAILS:')
              traceback.print_exc()
              exit(1)
          "
